"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TokenManager = void 0;
const msal_node_1 = require("@azure/msal-node");
const teams_api_1 = require("@microsoft/teams.api");
const teams_common_1 = require("@microsoft/teams.common");
const DEFAULT_BOT_TOKEN_SCOPE = 'https://api.botframework.com/.default';
const DEFAULT_GRAPH_TOKEN_SCOPE = 'https://graph.microsoft.com/.default';
const DEFAULT_TENANT_FOR_BOT_TOKEN = 'botframework.com';
const DEFAULT_TENANT_FOR_GRAPH_TOKEN = 'common';
const GET_DEFAULT_TOKEN_AUTHORITY = (tenantId) => `https://login.microsoftonline.com/${tenantId}`;
const MSAL_LOG_LEVEL_TO_LOG_LEVEL = {
    [msal_node_1.LogLevel.Error]: 'error',
    [msal_node_1.LogLevel.Warning]: 'warn',
    [msal_node_1.LogLevel.Info]: 'info',
    [msal_node_1.LogLevel.Verbose]: 'debug',
    [msal_node_1.LogLevel.Trace]: 'trace'
};
const LOG_LEVEL_TO_MSAL_LOG_LEVEL = {
    'error': msal_node_1.LogLevel.Error,
    'warn': msal_node_1.LogLevel.Warning,
    'info': msal_node_1.LogLevel.Info,
    'debug': msal_node_1.LogLevel.Verbose,
    'trace': msal_node_1.LogLevel.Trace
};
// Type guard functions
function isClientCredentials(credentials) {
    return 'clientSecret' in credentials;
}
function isTokenCredentials(credentials) {
    return 'token' in credentials;
}
function isFederatedIdentityCredentials(credentials) {
    return 'managedIdentityType' in credentials;
}
class TokenManager {
    credentials;
    logger;
    _msalLogger;
    confidentialClientsByTenantId = {};
    managedIdentityClient = null;
    constructor(options, logger) {
        this.logger = logger.child('TokenManager') ?? new teams_common_1.ConsoleLogger('TokenManager');
        this._msalLogger = this.logger.child('azure/msal-node', {
            // Msal logging is fairly noisy. So we keep it quiet unless the user
            // explicitly turns it on
            pattern: '-azure/msal-node'
        });
        this.credentials = this.initializeCredentials(options);
    }
    async getBotToken() {
        return await this.getToken(DEFAULT_BOT_TOKEN_SCOPE, this.resolveTenantId(undefined, DEFAULT_TENANT_FOR_BOT_TOKEN));
    }
    async getGraphToken(tenantId) {
        return await this.getToken(DEFAULT_GRAPH_TOKEN_SCOPE, this.resolveTenantId(tenantId, DEFAULT_TENANT_FOR_GRAPH_TOKEN));
    }
    initializeCredentials(options) {
        const clientId = options.clientId ?? process.env.CLIENT_ID;
        const tenantId = options.tenantId ?? process.env.TENANT_ID;
        const clientSecret = options.clientSecret ?? process.env.CLIENT_SECRET;
        const token = options.token;
        const managedIdentityClientId = options.managedIdentityClientId ?? process.env.MANAGED_IDENTITY_CLIENT_ID;
        if (clientId && clientSecret) {
            this.logger.debug('Using Client Credentials auth');
            return {
                clientId,
                clientSecret,
                tenantId,
            };
        }
        else if (clientId && token) {
            this.logger.debug(('Using custom token factory auth'));
            return {
                clientId,
                tenantId,
                token,
            };
        }
        else if (clientId && !clientSecret) {
            if (managedIdentityClientId == null || managedIdentityClientId.toLowerCase() === clientId.toLowerCase()) {
                this.logger.debug('Using user managed identity auth');
                return {
                    clientId,
                    tenantId
                };
            }
            else {
                const identityType = managedIdentityClientId === 'system' ? 'system' : 'user';
                this.logger.debug(`Using Federated Identity Credentials auth (${identityType})`);
                return {
                    clientId,
                    tenantId,
                    managedIdentityClientId,
                    managedIdentityType: identityType,
                };
            }
        }
        return undefined;
    }
    async getToken(scope, tenantId) {
        if (!this.credentials) {
            return null;
        }
        if (isClientCredentials(this.credentials)) {
            return this.getTokenWithClientCredentials(this.credentials, scope, tenantId);
        }
        else if (isTokenCredentials(this.credentials)) {
            return this.getTokenWithTokenProvider(this.credentials, scope, tenantId);
        }
        else if (isFederatedIdentityCredentials(this.credentials)) {
            return this.getTokenWithFederatedCredentials(this.credentials, scope, tenantId);
        }
        else {
            return this.getTokenWithManagedIdentity(this.credentials, scope);
        }
    }
    async getTokenWithClientCredentials(credentials, scope, tenantId) {
        const confidentialClient = this.getConfidentialClient(credentials, tenantId);
        const result = await confidentialClient.acquireTokenByClientCredential({ scopes: [scope] });
        return this.handleTokenResponse(result);
    }
    async getTokenWithTokenProvider(credentials, scope, tenantId) {
        const token = await credentials.token(scope, tenantId);
        return new teams_api_1.JsonWebToken(token);
    }
    async getTokenWithManagedIdentity(credentials, scope) {
        const managedIdentityClient = this.getManagedIdentityClient(credentials);
        // Resource doesn't need the ./default suffix
        const resource = scope.replace('/.default', '');
        const result = await managedIdentityClient.acquireToken({
            resource
        });
        return this.handleTokenResponse(result);
    }
    async getTokenWithFederatedCredentials(credentials, scope, tenantId) {
        const managedIdentityClient = this.getManagedIdentityClient(credentials);
        const managedIdentityTokenRes = await managedIdentityClient.acquireToken({ resource: 'api://AzureADTokenExchange' });
        const confidentialClient = new msal_node_1.ConfidentialClientApplication({
            auth: {
                clientId: credentials.clientId,
                clientAssertion: managedIdentityTokenRes.accessToken,
                authority: GET_DEFAULT_TOKEN_AUTHORITY(tenantId)
            },
            system: {
                loggerOptions: this.buildLoggerOptions()
            }
        });
        const result = await confidentialClient.acquireTokenByClientCredential({ scopes: [scope] });
        return this.handleTokenResponse(result);
    }
    resolveTenantId(tenantId, defaultTenantId) {
        return tenantId || this.credentials?.tenantId || defaultTenantId;
    }
    getConfidentialClient(credentials, tenantId) {
        const cachedClient = this.confidentialClientsByTenantId[tenantId];
        if (cachedClient) {
            return cachedClient;
        }
        const client = new msal_node_1.ConfidentialClientApplication({
            auth: {
                clientId: credentials.clientId,
                clientSecret: credentials.clientSecret,
                authority: GET_DEFAULT_TOKEN_AUTHORITY(tenantId)
            },
            system: {
                loggerOptions: this.buildLoggerOptions()
            }
        });
        this.confidentialClientsByTenantId[tenantId] = client;
        return client;
    }
    getManagedIdentityClient(credentials) {
        if (this.managedIdentityClient) {
            return this.managedIdentityClient;
        }
        if (isFederatedIdentityCredentials(credentials)) {
            if (credentials.managedIdentityType === 'user') {
                this.managedIdentityClient = new msal_node_1.ManagedIdentityApplication({
                    managedIdentityIdParams: {
                        userAssignedClientId: credentials.managedIdentityClientId
                    },
                    system: {
                        loggerOptions: this.buildLoggerOptions()
                    }
                });
            }
            else {
                this.managedIdentityClient = new msal_node_1.ManagedIdentityApplication({
                    managedIdentityIdParams: undefined, //no options automatically indicates system assigned managed identity
                    system: {
                        loggerOptions: this.buildLoggerOptions()
                    }
                });
            }
        }
        else {
            this.managedIdentityClient = new msal_node_1.ManagedIdentityApplication({
                managedIdentityIdParams: {
                    userAssignedClientId: credentials.clientId
                },
                system: {
                    loggerOptions: this.buildLoggerOptions()
                }
            });
        }
        return this.managedIdentityClient;
    }
    handleTokenResponse(result) {
        if (!result) {
            throw new Error('Failed to get token');
        }
        return new teams_api_1.JsonWebToken(result.accessToken);
    }
    buildLoggerOptions() {
        return {
            logLevel: this.logger.loggerOptions?.level != null ? LOG_LEVEL_TO_MSAL_LOG_LEVEL[this.logger.loggerOptions.level] : undefined,
            loggerCallback: (level, message) => {
                // There's a bug in MSAL where it warns this on all requests.
                // https://github.com/AzureAD/microsoft-authentication-library-for-js/issues/7917
                if (message.endsWith('Warning - No client info in response')) {
                    return;
                }
                this._msalLogger.log(MSAL_LOG_LEVEL_TO_LOG_LEVEL[level], message);
            },
            piiLoggingEnabled: false,
        };
    }
}
exports.TokenManager = TokenManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW4tbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90b2tlbi1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGdEQUFnSztBQUVoSyxvREFBNEs7QUFDNUssMERBQTJFO0FBRTNFLE1BQU0sdUJBQXVCLEdBQUcsdUNBQXVDLENBQUM7QUFDeEUsTUFBTSx5QkFBeUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUN6RSxNQUFNLDRCQUE0QixHQUFHLGtCQUFrQixDQUFDO0FBQ3hELE1BQU0sOEJBQThCLEdBQUcsUUFBUSxDQUFDO0FBQ2hELE1BQU0sMkJBQTJCLEdBQUcsQ0FBQyxRQUFnQixFQUFFLEVBQUUsQ0FBQyxxQ0FBcUMsUUFBUSxFQUFFLENBQUM7QUFFMUcsTUFBTSwyQkFBMkIsR0FBbUM7SUFDbEUsQ0FBQyxvQkFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU87SUFDN0IsQ0FBQyxvQkFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE1BQU07SUFDOUIsQ0FBQyxvQkFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU07SUFDM0IsQ0FBQyxvQkFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU87SUFDL0IsQ0FBQyxvQkFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU87Q0FDOUIsQ0FBQztBQUNGLE1BQU0sMkJBQTJCLEdBQW1DO0lBQ2xFLE9BQU8sRUFBRSxvQkFBWSxDQUFDLEtBQUs7SUFDM0IsTUFBTSxFQUFFLG9CQUFZLENBQUMsT0FBTztJQUM1QixNQUFNLEVBQUUsb0JBQVksQ0FBQyxJQUFJO0lBQ3pCLE9BQU8sRUFBRSxvQkFBWSxDQUFDLE9BQU87SUFDN0IsT0FBTyxFQUFFLG9CQUFZLENBQUMsS0FBSztDQUM1QixDQUFDO0FBSUYsdUJBQXVCO0FBQ3ZCLFNBQVMsbUJBQW1CLENBQUMsV0FBd0I7SUFDbkQsT0FBTyxjQUFjLElBQUksV0FBVyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLGtC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